---
name: "release"

on:
  push:
  schedule:
    - cron: '0 0 * * *'  # every day at midnight

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"

    steps:
      - uses: actions/checkout@v3
      - name: Get Enmity release
        uses: indiesdev/curl@v1.1
        id: enmity_release
        with:
          url: https://api.github.com/repos/enmity-mod/tweak/releases/latest
          accept: 200,201,204
          headers: '{ "Accept": "application/vnd.github+json" }'
          bearer-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Get Enmity version
        id: enmity_version
        run: echo ${{ steps.enmity_release.outputs.response }} | grep -P '(?<=v)[0-9]+\.[0-9]+\.[0-9]+' -o | echo "::set-output name=value::$(head -1)"
      - uses: actions/checkout@v3
      - name: Get EnmityCI release
        uses: indiesdev/curl@v1.1
        id: enmityci_release
        with:
          url: https://api.github.com/repos/devicarus/enmity-custom-icons/releases/latest
          accept: 200,201,204
          headers: '{ "Accept": "application/vnd.github+json" }'
          bearer-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Get EnmityCI version
        id: enmityci_version
        run: echo ${{ steps.enmityci_release.outputs.response }} | grep -P '(?<=v)[0-9]+\.[0-9]+\.[0-9]+' -o | echo "::set-output name=value::$(head -1)"
      - name: Compare versions
        id: compare
        run: echo "::set-output name=result::$(sh semver2.sh ${{ steps.enmity_version.outputs.value }} ${{ steps.enmityci_version.outputs.value }})"
      - name: Get Enmity download URL
        if: steps.compare.outputs.result==1
        id: download
        run: echo ${{ steps.enmity_release.outputs.response }} | grep -P 'https://[^:]+Enmity\.ipa' -o | echo "::set-output name=url::$(head -1)"
      - name: Download Enmity IPA
        if: steps.compare.outputs.result==1
        run: wget ${{ steps.download.outputs.url }}
      - name: Patch Enmity IPA
        if: steps.compare.outputs.result==1
        run: sh patch.sh
      - name: Release patched IPAs
        uses: "marvinpinto/action-automatic-releases@latest"
        if: steps.compare.outputs.result==1
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: v${{ steps.enmity_version.outputs.value }}
          files: |
            dist/*.ipa
